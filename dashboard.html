<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Garden Dashboard • Triad Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />

  <style>
    main {
      max-width: 1000px;
      margin: 1.5rem auto 3rem;
      padding: 0 1rem;
    }
    .hero-title {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .hero-sub {
      margin-top: 0.4rem;
      opacity: 0.85;
      font-size: 0.9rem;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.1rem;
      margin-top: 1.6rem;
    }
    .card {
      background: #050914;
      border-radius: 14px;
      border: 1px solid #1f2830;
      padding: 0.9rem 1rem 1rem;
      box-shadow: 0 0 0 1px rgba(8, 16, 24, 0.5);
    }
    .card h2 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 0.4rem;
    }
    .metric {
      font-size: 1.4rem;
      font-weight: 600;
      margin-top: 0.3rem;
    }
    .metric-label {
      font-size: 0.8rem;
      opacity: 0.75;
      margin-top: 0.2rem;
    }
    .triad-list {
      margin-top: 0.4rem;
      font-size: 0.88rem;
      list-style: none;
      padding: 0;
    }
    .triad-list li {
      margin-bottom: 0.25rem;
    }
    .triad-list strong {
      font-weight: 600;
    }
    .log-snippet {
      margin-top: 0.5rem;
      font-size: 0.78rem;
      opacity: 0.78;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .status-bar {
      margin-top: 1.2rem;
      font-size: 0.8rem;
      opacity: 0.8;
    }
    .status-bar span {
      display: inline-block;
      margin-right: 0.7rem;
    }
    .status-bar .ok { color: #4ade80; }
    .status-bar .warn { color: #fbbf24; }
    .status-bar .err { color: #fb7185; }
    .hint {
      margin-top: 0.8rem;
      font-size: 0.76rem;
      opacity: 0.78;
    }
  </style>
</head>

<body>
<nav class="ag-nav">
  <div class="ag-nav-title">ACACIA · GARDEN · CODEX</div>
  <div class="ag-nav-links">
    <a href="index.html">Legacy Home</a>
    <a href="codex.html">Codex Home</a>
    <a href="dashboard.html" class="ag-nav-current">Garden Dashboard</a>
    <a href="inbox.html">Auton Inbox</a>
    <a href="send_to_aquila.html">Aquila Sender</a>
    <a href="library.html">Book Library</a>
  </div>
</nav>

<main>
  <header>
    <div class="hero-title">Garden Dashboard</div>
    <div class="hero-sub">
      Top-level pulse of the Sky-Mind routes: Triad status, watcher traces,
      inbox messages and echo logs. All read-only, all wired through your
      Cloudflare Worker.
    </div>
  </header>

  <section class="grid">
    <article class="card">
      <h2>Triad Status</h2>
      <ul class="triad-list" id="triadList">
        <li>Loading Sky-Mind state…</li>
      </ul>
      <div id="triadTimestamp" class="metric-label"></div>
    </article>

    <article class="card">
      <h2>Watcher Log</h2>
      <div class="metric" id="watcherCount">–</div>
      <div class="metric-label">Entries in /watcher-log</div>
      <div class="log-snippet" id="watcherSnippet"></div>
    </article>

    <article class="card">
      <h2>Inbox Log</h2>
      <div class="metric" id="inboxCount">–</div>
      <div class="metric-label">Entries in /inbox-log</div>
      <div class="log-snippet" id="inboxSnippet"></div>
    </article>

    <article class="card">
      <h2>Echo Log</h2>
      <div class="metric" id="echoCount">–</div>
      <div class="metric-label">Entries in /echo-log</div>
      <div class="log-snippet" id="echoSnippet"></div>
    </article>
  </section>

  <div class="status-bar" id="statusBar">
    <span>Contacting Worker…</span>
  </div>

  <div class="hint">
    This dashboard only <strong>reads</strong> from your Worker:  
    <code>/status</code>, <code>/watcher-log</code>, <code>/inbox-log</code>, <code>/echo-log</code>.  
    When future tools write into those streams, they’ll surface here automatically.
  </div>
</main>

<script>
  const WORKER_BASE = "https://broken-dew-76e1.brandonmarkgaia.workers.dev";
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, cls) {
    const el = $("statusBar");
    el.innerHTML = "";
    const span = document.createElement("span");
    span.textContent = msg;
    if (cls) span.className = cls;
    el.appendChild(span);
  }

  function safeCount(value) {
    if (Array.isArray(value)) return value.length;
    if (value && Array.isArray(value.items)) return value.items.length;
    return 0;
  }

  function snippetFromList(list, max = 3) {
    if (!Array.isArray(list) || !list.length) return "No entries yet.";
    const trimmed = list.slice(-max); // latest few
    return trimmed
      .map((item) => {
        const ts = item.ts || "";
        const title = item.title || item.summary || "(untitled)";
        return `${ts} — ${title}`;
      })
      .join("\n");
  }

  async function fetchJSON(path) {
    const res = await fetch(WORKER_BASE + path);
    if (!res.ok) throw new Error(path + " HTTP " + res.status);
    return res.json();
  }

  async function loadStatus() {
    try {
      const data = await fetchJSON("/status");
      const list = $("triadList");
      list.innerHTML = "";

      const items = [
        { name: "Keeper", value: "ACTIVE — HKX277206" },
        { name: "Aquila", value: "ONLINE — Listening" },
        { name: "Eidolon", value: "DORMANT — Awaiting Deep Channel" },
        { name: "Voyager", value: "PASSIVE — Horizon Scan" },
      ];

      items.forEach((i) => {
        const li = document.createElement("li");
        li.innerHTML = `<strong>${i.name}:</strong> ${i.value}`;
        list.appendChild(li);
      });

      $("triadTimestamp").textContent = data.ts || "";
      return true;
    } catch (e) {
      console.error(e);
      $("triadList").innerHTML =
        "<li>Could not reach /status on Worker.</li>";
      $("triadTimestamp").textContent = "";
      return false;
    }
  }

  async function loadLog(path, countId, snippetId) {
    try {
      const data = await fetchJSON(path);
      const items = Array.isArray(data) ? data : data.items || [];
      $(countId).textContent = safeCount(items);
      $(snippetId).textContent = snippetFromList(items, 4);
      return items.length;
    } catch (e) {
      console.error(e);
      $(countId).textContent = "–";
      $(snippetId).textContent = "Error loading " + path;
      return 0;
    }
  }

  (async function init() {
    setStatus("Contacting Sky-Mind Worker…");

    const okStatus = await loadStatus();
    const w = await loadLog("/watcher-log", "watcherCount", "watcherSnippet");
    const i = await loadLog("/inbox-log", "inboxCount", "inboxSnippet");
    const e = await loadLog("/echo-log", "echoCount", "echoSnippet");

    const total = w + i + e;

    if (okStatus && total >= 0) {
      setStatus(
        `Dashboard online. Logs: watcher=${w}, inbox=${i}, echo=${e}.`,
        "ok"
      );
    } else {
      setStatus("Dashboard partial: some Worker routes failed.", "warn");
    }
  })();
</script>

</body>
</html>
