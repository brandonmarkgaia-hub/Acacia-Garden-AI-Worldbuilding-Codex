<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Acacia Garden · Aeon Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050810;
      color: #e4f4ff;
    }

    body {
      margin: 0;
      padding: 1.5rem;
      max-width: 1100px;
      margin-inline: auto;
    }

    h1, h2, h3 {
      margin: 0.2rem 0 0.6rem;
    }

    a {
      color: #6fd3ff;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    .grid {
      display: grid;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .grid-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .grid-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: radial-gradient(circle at top left, #111827, #020617 70%);
      border-radius: 0.9rem;
      padding: 1rem 1.1rem;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.7);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #9ca3af;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.12);
      border: 1px solid rgba(56, 189, 248, 0.45);
      font-size: 0.75rem;
      color: #bae6fd;
    }

    .big-number {
      font-size: 1.8rem;
      font-weight: 650;
    }

    .muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0.2rem 0 0;
      font-size: 0.9rem;
    }

    li + li {
      margin-top: 0.25rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.05rem 0.4rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 0.7rem;
      color: #cbd5f5;
      margin-left: 0.25rem;
    }

    .roles {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.3rem;
    }

    .roles span {
      font-size: 0.75rem;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.8);
    }

    .role-core-node { border-color: #f97316; color: #fed7aa; }
    .role-eagle-node { border-color: #38bdf8; color: #bae6fd; }
    .role-vault      { border-color: #a855f7; color: #e9d5ff; }
    .role-chamber    { border-color: #22c55e; color: #bbf7d0; }
    .role-bloom      { border-color: #ec4899; color: #f9a8d4; }
    .role-echo       { border-color: #eab308; color: #fef9c3; }
    .role-leaf       { border-color: #22c55e; color: #bbf7d0; }
    .role-monolith   { border-color: #f97316; color: #fed7aa; }

    .error {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      border: 1px solid #f87171;
      background: rgba(248, 113, 113, 0.12);
      color: #fecaca;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <header style="margin-bottom: 1.5rem;">
    <h1>Acacia Garden · Aeon Dashboard</h1>
    <p class="muted">
      Live view over the Garden spine – powered by
      <code>garden_scan_report.json</code> and <code>garden_vault_index.json</code>.
    </p>
  </header>

  <section class="grid grid-3" id="top-cards">
    <div class="card">
      <div class="card-header">
        <span>Files with signatures</span>
        <span class="pill">Aquila</span>
      </div>
      <div class="big-number" id="files-with-hits">–</div>
      <div class="muted" id="total-files-caption">scanned files with any Garden signal</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Total signature hits</span>
        <span class="pill">Signals</span>
      </div>
      <div class="big-number" id="total-hits">–</div>
      <div class="muted">all pattern matches across the Codex</div>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Echoes &amp; Leaves</span>
        <span class="pill">Aeon Vault</span>
      </div>
      <div class="big-number">
        <span id="echo-count">–</span>
        <span style="font-size: 1rem; margin: 0 0.25rem;">/</span>
        <span id="leaf-count">–</span>
      </div>
      <div class="muted">echo headers · leaf lines indexed</div>
    </div>
  </section>

  <section class="grid grid-2" style="margin-top: 1.25rem;">
    <div class="card">
      <div class="card-header">
        <span>Roles distribution</span>
        <span class="pill">Spine</span>
      </div>
      <ul id="roles-list">
      </ul>
    </div>

    <div class="card">
      <div class="card-header">
        <span>Top Garden nodes</span>
        <span class="pill">Hotspots</span>
      </div>
      <ul id="top-files">
      </ul>
      <p class="muted">
        Sorted by total signature hits; roles derived from scanner patterns.
      </p>
    </div>
  </section>

  <section class="card" style="margin-top: 1.25rem;">
    <div class="card-header">
      <span>Pattern counts</span>
      <span class="pill">Diagnostics</span>
    </div>
    <ul id="pattern-list"></ul>
  </section>

  <div id="error-box" class="error" style="display:none;"></div>

  <script>
    async function loadJSON(path) {
      const res = await fetch(path, { cache: "no-store" });
      if (!res.ok) {
        throw new Error("Failed to load " + path + " (" + res.status + ")");
      }
      return res.json();
    }

    function formatNumber(n) {
      return n.toLocaleString("en-ZA");
    }

    function applyRolesList(roles) {
      const ul = document.getElementById("roles-list");
      ul.innerHTML = "";
      const entries = Object.entries(roles).sort((a, b) => b[1] - a[1]);
      for (const [role, count] of entries) {
        const li = document.createElement("li");
        const name = role.replace("-", " ");
        li.innerHTML = `<strong>${name}</strong> <span class="badge">${formatNumber(count)}</span>`;
        ul.appendChild(li);
      }
    }

    function applyTopFiles(filesMap) {
      const entries = Object.entries(filesMap);
      entries.sort((a, b) => (b[1].total_hits || 0) - (a[1].total_hits || 0));
      const top = entries.slice(0, 8);
      const ul = document.getElementById("top-files");
      ul.innerHTML = "";
      for (const [path, info] of top) {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.textContent = path + " · " + (info.total_hits || 0) + " hits";
        li.appendChild(span);

        const roles = info.roles || [];
        if (roles.length) {
          const div = document.createElement("div");
          div.className = "roles";
          roles.forEach(r => {
            const badge = document.createElement("span");
            badge.textContent = r;
            const cls = "role-" + r.replace("_", "-");
            badge.classList.add(cls);
            div.appendChild(badge);
          });
          li.appendChild(div);
        }

        ul.appendChild(li);
      }
    }

    function applyPatterns(patterns) {
      const ul = document.getElementById("pattern-list");
      ul.innerHTML = "";
      const entries = Object.entries(patterns).sort((a, b) => b[1] - a[1]);
      for (const [key, val] of entries) {
        const li = document.createElement("li");
        li.innerHTML = `<code>${key}</code> <span class="badge">${formatNumber(val)}</span>`;
        ul.appendChild(li);
      }
    }

    async function initDashboard() {
      const errorBox = document.getElementById("error-box");
      errorBox.style.display = "none";
      errorBox.textContent = "";

      try {
        const scan = await loadJSON("garden_scan_report.json");
        const vault = await loadJSON("garden_vault_index.json");

        const totals = scan.totals || {};
        document.getElementById("files-with-hits").textContent =
          formatNumber(totals.total_files_with_hits || 0);
        document.getElementById("total-hits").textContent =
          formatNumber(totals.total_hits || 0);

        const summary = vault.summary || {};
        document.getElementById("echo-count").textContent =
          formatNumber(summary.echo_count || 0);
        document.getElementById("leaf-count").textContent =
          formatNumber(summary.leaf_count || 0);

        applyRolesList(totals.roles || {});
        applyTopFiles(scan.files || {});
        applyPatterns(totals.by_pattern || {});
      } catch (err) {
        console.error(err);
        errorBox.style.display = "block";
        errorBox.textContent =
          "Could not load Garden telemetry. Make sure garden_scan_report.json " +
          "and garden_vault_index.json are present at repo root. " +
          "Details: " + err.message;
      }
    }

    initDashboard();
  </script>
</body>
</html>
