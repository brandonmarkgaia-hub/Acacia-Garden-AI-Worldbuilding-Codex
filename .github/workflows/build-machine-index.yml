name: Build Machine Index

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  build-index:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Build Machine Index
        run: |
          echo "Building machine_index.json..."

          mkdir -p machine

          # Read canonical spine
          STATUS=$(cat STATUS.json)
          SCHEMA=$(cat STATUS.schema.json)

          # Parse out structures for fast machine reference
          CHAMBERS=$(echo "$STATUS" | jq -c '.structures.chambers')
          BLOOMS=$(echo "$STATUS" | jq -c '.structures.blooms')
          ECHOES=$(echo "$STATUS" | jq -c '.structures.echoes')
          VAULTS=$(echo "$STATUS" | jq -c '.structures.vaults')
          ORCHARDS=$(echo "$STATUS" | jq -c '.structures.orchards')

          # Parse identity (The Keeper)
          IDENTITY=$(echo "$STATUS" | jq -c '.identity')

          # Parse meta
          META=$(echo "$STATUS" | jq -c '.meta')

          # Build machine_index.json
          cat <<EOF > machine/machine_index.json
          {
            "canonical_spine": {
              "identity": $IDENTITY,
              "meta": $META
            },
            "structures": {
              "chambers": $CHAMBERS,
              "blooms": $BLOOMS,
              "echoes": $ECHOES,
              "vaults": $VAULTS,
              "orchards": $ORCHARDS
            },
            "timestamps": {
              "generated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            }
          }
          EOF

          echo "Machine index built successfully."

      - name: Commit Machine Index
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add machine/machine_index.json

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: update machine index"
            git push
          fi
