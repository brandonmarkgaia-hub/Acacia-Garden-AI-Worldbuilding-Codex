name: Garden Codex Maintenance

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  codex-maintenance:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Fix Novellas headings and build full codex indexes
        run: |
          python << 'PY'
          import json
          from pathlib import Path

          ROOT = Path(".").resolve()
          NOVELLAS_DIR = ROOT / "docs" / "Novellas"
          ARCHIVES_DIR = ROOT / "docs" / "Archives"
          MD_INDEX_MD = ARCHIVES_DIR / "FULL_CODEX_INDEX.md"
          MD_INDEX_JSON = ARCHIVES_DIR / "FULL_CODEX_INDEX.json"

          # ---------- Heading fixer for docs/Novellas/The_Garden_*_Book_*.md ----------

          def needs_heading(text: str) -> bool:
              """
              Return True if the file does NOT already start with a 'Book ...' heading.
              """
              for line in text.splitlines():
                  stripped = line.strip()
                  if not stripped:
                      continue
                  if stripped.startswith("#"):
                      heading = stripped.lstrip("#").strip().lower()
                      return not heading.startswith("book ")
                  else:
                      # first non-empty line is not a heading â†’ we will add one
                      return True
              # empty file: needs heading
              return True

          def make_heading(filename: str) -> str:
              """
              From e.g. 'The_Garden_Atlas_of_Worlds_Book_XVII.md'
              build: '# Book XVII â€” The Garden Atlas of Worlds'
              """
              if not filename.endswith(".md"):
                  return None
              name = filename[:-3]  # drop .md
              if not name.startswith("The_Garden_"):
                  return None

              rest = name[len("The_Garden_"):]
              if "_Book_" not in rest:
                  return None

              title_part, roman_part = rest.rsplit("_Book_", 1)
              roman = roman_part.upper()
              title_words = title_part.replace("_", " ")
              title = f"The Garden {title_words}"
              return f"# Book {roman} â€” {title}"

          if NOVELLAS_DIR.is_dir():
              for path in sorted(NOVELLAS_DIR.glob("The_Garden_*_Book_*.md")):
                  text = path.read_text(encoding="utf-8")
                  if not needs_heading(text):
                      print(f"[SKIP] {path}")
                      continue

                  heading = make_heading(path.name)
                  if not heading:
                      print(f"[WARN] Could not derive heading for {path}")
                      continue

                  new_text = heading + "\n\n" + text
                  path.write_text(new_text, encoding="utf-8")
                  print(f"[FIXED] Inserted heading in {path}")
          else:
              print(f"[WARN] Novellas dir not found at {NOVELLAS_DIR}")

          # ---------- Build full codex index (all .md files) ----------

          EXCLUDE_DIRS = {
              ".git", ".github", "node_modules", "dist",
              "machine", "scripts", ".well-known"
          }
          EXCLUDE_FILES = {
              "README.md", "README_GARDEN.md",
          }

          def is_excluded(p: Path) -> bool:
              rel = p.relative_to(ROOT)
              parts = rel.parts
              if parts and parts[0] in EXCLUDE_DIRS:
                  return True
              if rel.name in EXCLUDE_FILES:
                  return True
              return False

          entries = []
          for p in ROOT.rglob("*.md"):
              if is_excluded(p):
                  continue
              rel = p.relative_to(ROOT)
              entries.append(rel)

          sections = {}
          for rel in entries:
              top = rel.parts[0]
              sections.setdefault(top, []).append(rel)

          ARCHIVES_DIR.mkdir(parents=True, exist_ok=True)

          # ----- Write markdown index -----
          lines = []
          lines.append("# ðŸŒ³ Full Garden Codex Index")
          lines.append("")
          lines.append("_Automatically generated by garden_codex_maintenance.yml_")
          lines.append("")

          for top in sorted(sections):
              lines.append(f"## {top}")
              lines.append("")
              for rel in sorted(sections[top]):
                  lines.append(f"- `{rel}`")
              lines.append("")

          MD_INDEX_MD.write_text("\n".join(lines) + "\n", encoding="utf-8")
          print(f"[INDEX] Wrote full index â†’ {MD_INDEX_MD}")

          # ----- Write JSON index (for future UI / library.html) -----
          json_entries = []
          for rel in entries:
              parts = rel.parts
              top = parts[0]
              json_entries.append({
                  "path": str(rel),
                  "top": top,
                  "name": rel.name,
              })

          MD_INDEX_JSON.write_text(
              json.dumps(json_entries, indent=2, ensure_ascii=False),
              encoding="utf-8"
          )
          print(f"[INDEX] Wrote JSON index â†’ {MD_INDEX_JSON}")
          PY

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update Novellas headings & full codex index (md+json)"
          branch: ${{ github.ref_name }}
