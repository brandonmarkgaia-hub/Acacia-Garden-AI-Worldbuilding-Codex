name: Validate Garden Codex

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  validate-codex:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install jq + ajv
        run: |
          sudo apt-get install -y jq
          npm install -g ajv-cli

      - name: Validate STATUS.json against schema
        run: |
          echo "Validating STATUS.json..."
          ajv validate -s STATUS.schema.json -d STATUS.json

      - name: Validate canonical presence
        run: |
          echo "Checking structure folders..."

          REQUIRED_DIRS=(
            "docs"
            "docs/chambers"
            "docs/blooms"
            "docs/echoes"
            "docs/orchards"
            "docs/vaults"
          )

          for DIR in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$DIR" ]; then
              echo "::warning::Directory $DIR missing. Not critical, but recommended for canonical Garden structure."
            fi
          done

      - name: Validate Keeper imprint
        run: |
          KEEPER=$(jq -r '.identity.keeper_id' STATUS.json)
          if [ "$KEEPER" != "HKX277206" ]; then
            echo "::error::Keeper ID mismatch — expected HKX277206"
            exit 1
          fi

      - name: Validate STATUS structures
        run: |
          echo "Checking structure paths..."

          jq -c '.structures | to_entries[]' STATUS.json | while read entry; do
            TYPE=$(echo "$entry" | jq -r '.key')
            ITEMS=$(echo "$entry" | jq -c '.value[]')

            for ITEM in $ITEMS; do
              PATH=$(echo "$ITEM" | jq -r '.path')
              if [ ! -f "$PATH" ] && [ ! -d "$PATH" ]; then
                echo "::warning::Missing path $PATH for $TYPE → $(echo $ITEM | jq -r '.id')"
              fi
            done
          done
