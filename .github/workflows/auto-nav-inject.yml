name: Auto inject top navigation into all HTML

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  inject-nav:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Build canonical nav block
        run: |
          cat > nav_block.html << 'EOF'
          <nav class="ag-nav">
              <div class="ag-nav-title">
                  ACACIA · GARDEN · CODEX
              </div>
              <div class="ag-nav-links">
                  <a href="index.html">Legacy Home</a>
                  <a href="codex.html">Codex Home</a>
                  <a href="dashboard.html">Garden Dashboard</a>
                  <a href="inbox.html">Auton Inbox</a>
                  <a href="send_to_aquila.html">Aquila Sender</a>
                  <a href="library.html">Book Library</a>
                  <a href="elias.html">Elias Kernel</a>
                  <a href="r9x2.html">R9X2 Language</a>
                  <a href="mosaic_endgame.html">Mosaic Endgame</a>
                  <a href="deep_garden.html">Deep Garden Docs</a>
                  <a href="gardenos.html">GardenOS</a>
              </div>
          </nav>
          EOF

      - name: Inject nav into all HTML files
        run: |
          python << 'PY'
          import pathlib, re

          NAV_PATH = pathlib.Path("nav_block.html")
          nav_html = NAV_PATH.read_text(encoding="utf-8")

          # Directories we never touch
          SKIP_DIRS = {".git", ".github", "node_modules"}

          def should_skip(path: pathlib.Path) -> bool:
              return any(parent.name in SKIP_DIRS for parent in path.parents)

          for html_path in pathlib.Path(".").rglob("*.html"):
              if should_skip(html_path):
                  continue

              text = html_path.read_text(encoding="utf-8")

              # 1) Remove any existing <nav class="ag-nav">...</nav>
              text = re.sub(
                  r'<nav class="ag-nav">.*?</nav>\s*',
                  '',
                  text,
                  count=1,
                  flags=re.S,
              )

              # 2) Inject fresh nav immediately after <body>
              def inject_after_body(m):
                  return m.group(0) + "\n" + nav_html + "\n"

              if re.search(r"<body[^>]*>", text, flags=re.I):
                  text = re.sub(
                      r"<body[^>]*>",
                      inject_after_body,
                      text,
                      count=1,
                      flags=re.I,
                  )
              else:
                  # Fallback: prepend nav if somehow no <body> tag
                  text = nav_html + "\n" + text

              # 3) Strip any old ag-nav-current classes
              def strip_current(m):
                  classes = m.group(1).split()
                  classes = [c for c in classes if c != "ag-nav-current"]
                  if classes:
                      return ' class="' + " ".join(classes) + '"'
                  else:
                      return ""

              text = re.sub(
                  r'\s+class="([^"]*ag-nav-current[^"]*)"',
                  strip_current,
                  text,
              )

              # 4) Mark current page in the nav
              this_name = html_path.name
              text = re.sub(
                  rf'href="{re.escape(this_name)}"',
                  rf'href="{this_name}" class="ag-nav-current"',
                  text,
              )

              html_path.write_text(text, encoding="utf-8")

          PY

      - name: Commit changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add . || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: harmonize nav across all HTML pages"
            git push
          fi
