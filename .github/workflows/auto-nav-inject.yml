name: Inject Navigation Into HTML

on:
  workflow_dispatch:
  push:
    paths:
      - "*.html"

jobs:
  inject-nav:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Inject nav into all HTML files
        run: |
          cat << 'EOF' > nav_block.html
<nav class="ag-nav">
    <div class="ag-nav-title">
        ACACIA · GARDEN · CODEX
    </div>
    <div class="ag-nav-links">
        <a href="index.html">Legacy Home</a>
        <a href="codex.html">Codex Home</a>
        <a href="dashboard.html">Garden Dashboard</a>
        <a href="inbox.html">Auton Inbox</a>
        <a href="send_to_aquila.html">Aquila Sender</a>
        <a href="library.html">Book Library</a>
    </div>
</nav>
EOF

          for f in *.html; do
            echo "Processing $f"

            # Remove old nav block if present
            sed -i '/<nav class="ag-nav">/,/<\/nav>/d' "$f"

            # Insert the new nav block after <body>
            awk '
              /<body>/ {
                print;
                system("cat nav_block.html");
                next
              }
              {print}
            ' "$f" > temp && mv temp "$f"

            # Clear old current markers
            sed -i 's/class="ag-nav-current"//g' "$f"

            # Add new current marker
            THIS=$(basename "$f")
            sed -i "s|href=\"$THIS\"|href=\"$THIS\" class=\"ag-nav-current\"|" "$f"

          done

      - name: Commit updated HTML
        run: |
          git config user.name "Garden-Auton"
          git config user.email "auton@garden"
          git add *.html nav_block.html
          git commit -m "Auton: Updated navigation across Codex" || echo "No changes"
          git push
