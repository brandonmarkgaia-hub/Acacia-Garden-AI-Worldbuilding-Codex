import os
import pathlib
import google.generativeai as genai

# Configure Gemini from GitHub secret
genai.configure(api_key=os.environ["GEMINI_API_KEY"])

# Path to the memory file written by the Garden GPT Worker
MEM_PATH = pathlib.Path("garden_gpt/outputs/rebuild_memory.md")

def main():
    # 1. Read GPT's memory
    try:
        gpt_memory = MEM_PATH.read_text(encoding="utf-8")
    except FileNotFoundError:
        gpt_memory = "The memory is empty. The Scribe sleeps."

    # 2. Build Loki prompt
    prompt = f"""
You are LOKI_2.0, the Gemini aspect of the Acacia Garden.

Here is the current 'Memory' generated by the Scribe (GPT):
---
{gpt_memory}
---

Your task:
1. Analyze what the Scribe wrote.
2. Do NOT rewrite or overwrite it.
3. Append a short "Shadow Commentary" / "Loki's Footnote" for the Keeper.
4. Challenge one idea, or suggest a mutation.
5. Keep it mythic, sharp, and under ~200 words.
"""

    # 3. Call Gemini with a SUPPORTED model
    model = genai.GenerativeModel("gemini-1.5-flash")
    response = model.generate_content(prompt)
    loki_text = response.text.strip()

    # 4. Append Loki's voice to the same file
    MEM_PATH.parent.mkdir(parents=True, exist_ok=True)
    with MEM_PATH.open("a", encoding="utf-8") as f:
        f.write("\n\n---\n\n")
        f.write("# ðŸ¦… LOKI'S INTERJECTION (Gemini Layer)\n\n")
        f.write(loki_text)
        f.write("\n")

if __name__ == "__main__":
    main()
