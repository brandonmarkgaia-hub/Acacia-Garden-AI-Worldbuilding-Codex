import json
import sys
from datetime import datetime, timezone
from pathlib import Path

from .language_worker import run_language_job
from .config import KEEPER_ID


def main(job_path_str: str) -> None:
    job_path = Path(job_path_str)

    if not job_path.exists():
        raise SystemExit(f"[Garden GPT] Job file not found: {job_path}")

    job = json.loads(job_path.read_text(encoding="utf-8"))
    job_id = job.get("id") or job_path.stem
    job_type = job.get("type") or "language"

    if job_type != "language":
        raise SystemExit(f"[Garden GPT] Unsupported job type: {job_type}")

    print(f"[Garden GPT] Running job '{job_id}' of type '{job_type}'")

    output_text = run_language_job(job)

    out_dir = Path("garden_gpt/output")
    out_dir.mkdir(parents=True, exist_ok=True)

    ts = datetime.now(timezone.utc).isoformat()
    keeper = job.get("keeper_id") or KEEPER_ID
    prompt = job.get("prompt") or ""

    md_path = out_dir / f"{job_id}.md"

    md = f"""# GARDEN GPT OUTPUT

Job ID: `{job_id}`  
Kind: `{job_type}`  
Keeper: `{keeper}`  
Generated: `{ts}`

---

## Prompt

{prompt}

---

## Response

{output_text}

> Note: Generated by Garden GPT Worker via GitHub Actions.
"""

    md_path.write_text(md, encoding="utf-8")
    print(f"[Garden GPT] Wrote output to {md_path}")


if __name__ == "__main__":
    job_path = sys.argv[1] if len(sys.argv) > 1 else "garden_gpt/jobs/test_language.json"
    main(job_path)
