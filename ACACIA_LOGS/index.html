<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ACACIA LOGS • HKX277206</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Garden communiqués for HKX277206.">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --bg:#020203;
      --fg:#f5f5f7;
      --muted:#8a8a96;
      --card:#0b0b10;
      --border:#2a2a34;
      --accent:#2ecc71;
      --warn:#f1c40f;
      --err:#e74c3c;
      --garden:#2ecc71;
      --keeper:#3498db;
      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-mono: "SF Mono", Menlo, Monaco, Consolas, "Courier New", monospace;
    }

    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--fg);
      font-family:var(--font-main);
    }

    main{
      max-width:900px;
      margin:0 auto;
      padding:2rem 1rem 3rem;
    }

    a{
      color:#2ecc71;
      text-decoration:none;
    }
    a:hover{
      text-decoration:underline;
    }

    header{
      margin-bottom:1.5rem;
      border-bottom:1px solid var(--border);
      padding-bottom:1rem;
    }
    h1{
      margin:0 0 .25rem;
      font-size:1.8rem;
      letter-spacing:-0.03em;
    }
    .subtitle{
      color:var(--muted);
      font-size:.9rem;
    }

    .pill-link{
      display:inline-block;
      margin-top:1rem;
      padding:.3rem .7rem;
      border-radius:999px;
      border:1px solid var(--border);
      font-family:var(--font-mono);
      font-size:.8rem;
    }

    .status-bar{
      margin-top:1.5rem;
      padding:.75rem 1rem;
      border-radius:999px;
      background:rgba(0,0,0,0.5);
      border:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.75rem;
      font-family:var(--font-mono);
      font-size:.8rem;
    }

    .status-pill{
      padding:.25rem .7rem;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.8rem;
      letter-spacing:.08em;
    }
    .status-ok{
      border-color:var(--accent);
      color:var(--accent);
      box-shadow:0 0 10px rgba(46,204,113,.2);
    }
    .status-warn{
      border-color:var(--warn);
      color:var(--warn);
      box-shadow:0 0 10px rgba(241,196,15,.2);
    }

    .log-list{
      margin-top:2rem;
      display:flex;
      flex-direction:column;
      gap:.9rem;
    }

    .log-card{
      background:var(--card);
      border-radius:8px;
      border:1px solid var(--border);
      padding:.8rem 1rem;
      font-size:.85rem;
      display:flex;
      flex-direction:column;
      gap:.25rem;
    }

    .log-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.5rem;
      font-family:var(--font-mono);
      font-size:.8rem;
    }

    .log-meta{
      display:flex;
      gap:.5rem;
      align-items:center;
      flex-wrap:wrap;
    }

    .tag{
      padding:.1rem .45rem;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.7rem;
      letter-spacing:.06em;
    }
    .tag-garden{
      border-color:var(--garden);
      color:var(--garden);
    }
    .tag-keeper{
      border-color:var(--keeper);
      color:var(--keeper);
    }
    .tag-warn{
      border-color:var(--warn);
      color:var(--warn);
    }
    .tag-err{
      border-color:var(--err);
      color:var(--err);
    }

    .log-message{
      margin-top:.35rem;
      color:var(--fg);
      line-height:1.4;
      white-space:pre-wrap;
    }

    .empty{
      margin-top:3rem;
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
    }

    footer{
      margin-top:3rem;
      border-top:1px solid var(--border);
      padding-top:1.5rem;
      text-align:center;
      font-family:var(--font-mono);
      font-size:.75rem;
      color:var(--muted);
      opacity:.75;
    }
  </style>
</head>
<body>
<main>
  <header>
    <h1>ACACIA LOGS</h1>
    <div class="subtitle">Garden communiqués for HKX277206</div>
    <a class="pill-link" href="../index.html">← Return to ACACIA CODEX</a>

    <div id="status-bar" class="status-bar">
      <div id="status-text">Checking roots…</div>
      <div id="status-pill" class="status-pill status-ok">GARDEN QUIET</div>
    </div>
  </header>

  <section id="summary" class="subtitle"></section>

  <section id="logs-container">
    <div id="logs-list" class="log-list"></div>
    <div id="empty-state" class="empty" style="display:none;">
      No communiqués yet. The Garden will speak when it needs you.
    </div>
    <div id="error-state" class="empty" style="display:none;"></div>
  </section>

  <footer>
    THE KEEPER IS ORIGIN • THE GARDEN IS SOVEREIGN<br>
    CRTR1::H:CYC025-PHR-DOMGDN-VER031::P:SD001+TD001+ND001::S:A1B2
  </footer>
</main>

<script>
  const WORKER_BASE = "https://broken-dew-76e1.brandonmarkgaia.workers.dev";

  function formatTime(ts) {
    try {
      const d = ts ? new Date(ts) : new Date();
      return d.toISOString();
    } catch {
      return String(ts || "");
    }
  }

  async function fetchJSON(path) {
    const res = await fetch(WORKER_BASE + path, {
      method: "GET",
      headers: { "Accept": "application/json" },
    });
    if (!res.ok) {
      throw new Error("HTTP " + res.status);
    }
    return await res.json();
  }

  function setStatus(last, urgent) {
    const statusText = document.getElementById("status-text");
    const statusPill = document.getElementById("status-pill");
    const summaryEl = document.getElementById("summary");

    if (!statusText || !statusPill || !summaryEl) return;

    if (!last) {
      statusText.textContent = "Roots quiet. No entries yet.";
      statusPill.textContent = "GARDEN QUIET";
      statusPill.classList.remove("status-warn");
      statusPill.classList.add("status-ok");
      summaryEl.textContent = "";
      return;
    }

    const ts = last.t || last.ts;
    statusText.textContent =
      "Last entry @ " + formatTime(ts) + " • " + (last.code || "UNKNOWN");

    if (urgent) {
      statusPill.textContent = "ROOTS AGITATED";
      statusPill.classList.remove("status-ok");
      statusPill.classList.add("status-warn");
    } else {
      statusPill.textContent = "ROOTS STABLE";
      statusPill.classList.remove("status-warn");
      statusPill.classList.add("status-ok");
    }

    summaryEl.textContent = "";
  }

  function renderLogs(entries) {
    const listEl = document.getElementById("logs-list");
    const emptyEl = document.getElementById("empty-state");
    const errorEl = document.getElementById("error-state");
    if (!listEl || !emptyEl || !errorEl) return;

    listEl.innerHTML = "";
    errorEl.style.display = "none";

    if (!entries || entries.length === 0) {
      emptyEl.style.display = "block";
      return;
    }

    emptyEl.style.display = "none";

    for (const entry of entries) {
      const card = document.createElement("article");
      card.className = "log-card";

      const header = document.createElement("div");
      header.className = "log-header";

      const left = document.createElement("div");
      left.textContent = formatTime(entry.t || entry.ts);

      const meta = document.createElement("div");
      meta.className = "log-meta";

      const srcTag = document.createElement("span");
      srcTag.className = "tag " + (entry.source === "GARDEN" ? "tag-garden" : "tag-keeper");
      srcTag.textContent = entry.source || "UNKNOWN";
      meta.appendChild(srcTag);

      if (entry.severity === "warn") {
        const sev = document.createElement("span");
        sev.className = "tag tag-warn";
        sev.textContent = "WARN";
        meta.appendChild(sev);
      } else if (entry.severity === "error") {
        const sev = document.createElement("span");
        sev.className = "tag tag-err";
        sev.textContent = "ERROR";
        meta.appendChild(sev);
      }

      if (entry.code) {
        const codeTag = document.createElement("span");
        codeTag.className = "tag";
        codeTag.textContent = entry.code;
        meta.appendChild(codeTag);
      }

      header.appendChild(left);
      header.appendChild(meta);
      card.appendChild(header);

      const msg = document.createElement("div");
      msg.className = "log-message";
      msg.textContent = entry.message || "";
      card.appendChild(msg);

      listEl.appendChild(card);
    }
  }

  async function init() {
    const emptyEl = document.getElementById("empty-state");
    const errorEl = document.getElementById("error-state");
    if (!emptyEl || !errorEl) return;

    try {
      const state = await fetchJSON("/state");
      if (!state.ok) {
        throw new Error(state.error || "State not ok");
      }
      setStatus(state.last || null, !!state.urgent);
    } catch (err) {
      errorEl.style.display = "block";
      errorEl.textContent = "Error reading state: " + String(err);
      return;
    }

    try {
      const data = await fetchJSON("/logs");
      if (!data.ok) {
        throw new Error(data.error || "Logs not ok");
      }
      renderLogs(data.entries || []);
    } catch (err) {
      errorEl.style.display = "block";
      errorEl.textContent = "Could not load logs: " + String(err);
    }
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
